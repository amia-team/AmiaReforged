@page "/encounters"
@using Microsoft.AspNetCore.Authorization
@using AmiaReforged.AdminPanel.Models
@using AmiaReforged.AdminPanel.Services
@attribute [Authorize]
@inject EncounterApiService Api
@inject IWorldEngineEndpointService EndpointService
@inject ILogger<Encounters> Logger
@rendermode InteractiveServer

<PageTitle>Encounters - Amia Admin Panel</PageTitle>

<div class="encounters-page">
    <div class="dashboard-header">
        <h1>Encounter Profiles</h1>
        <div class="header-actions">
            @if (_endpoints.Count > 0)
            {
                <div class="instance-selector">
                    <label class="instance-label">Server:</label>
                    <select class="form-control form-control-sm" value="@(_selectedEndpoint?.Id.ToString() ?? "")" @onchange="OnEndpointChanged">
                        <option value="">— Select —</option>
                        @foreach (var ep in _endpoints)
                        {
                            <option value="@ep.Id">@ep.Name</option>
                        }
                    </select>
                </div>
            }
            <button class="btn btn-sm btn-outline-info" @onclick="() => _showEndpointManager = !_showEndpointManager">
                @(_showEndpointManager ? "Hide Servers" : "Manage Servers")
            </button>
            @if (_selectedEndpoint != null)
            {
                <button class="btn btn-secondary" @onclick="RefreshProfiles">Refresh</button>
                <button class="btn btn-primary" @onclick="() => _showCreateForm = !_showCreateForm">+ New Profile</button>
                <button class="btn btn-warning btn-sm" @onclick="RefreshCache" disabled="@_isRefreshingCache">
                    @(_isRefreshingCache ? "Refreshing..." : "Refresh Cache")
                </button>
            }
            <a href="/" class="btn btn-secondary">← Dashboard</a>
        </div>
    </div>

    @if (_error != null)
    {
        <div class="alert alert-danger">@_error <button class="btn btn-sm btn-secondary" style="margin-left:10px" @onclick="() => _error = null">Dismiss</button></div>
    }
    @if (_success != null)
    {
        <div class="alert alert-success">@_success <button class="btn btn-sm btn-secondary" style="margin-left:10px" @onclick="() => _success = null">Dismiss</button></div>
    }

    @* ===== Endpoint Manager ===== *@
    @if (_showEndpointManager)
    {
        <div class="section" style="margin-bottom:20px">
            <h2>WorldEngine Server Endpoints</h2>
            <p style="color:var(--text-secondary);font-size:0.9rem">
                Add the base URL of each WorldEngine server you want to manage. Endpoints are saved to disk.
            </p>

            @* Add form *@
            <div class="inline-form" style="margin-bottom:15px;padding:15px;background:var(--bg-input);border-radius:8px">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name</label>
                        <input class="form-control" @bind="_epName" placeholder="e.g. Production" maxlength="64" />
                    </div>
                    <div class="form-group" style="flex:2">
                        <label>Base URL</label>
                        <input class="form-control" @bind="_epUrl" placeholder="http://nwserver:8080" />
                    </div>
                    <div class="form-group">
                        <label>API Key <span style="color:var(--text-secondary);font-weight:normal">(optional)</span></label>
                        <input class="form-control" type="password" @bind="_epApiKey" placeholder="Bearer token" />
                    </div>
                </div>
                <div class="form-actions">
                    @if (_editingEndpointId == null)
                    {
                        <button class="btn btn-success btn-sm" @onclick="AddEndpoint" disabled="@_isSavingEndpoint">Add Server</button>
                    }
                    else
                    {
                        <button class="btn btn-primary btn-sm" @onclick="SaveEditEndpoint" disabled="@_isSavingEndpoint">Save</button>
                        <button class="btn btn-secondary btn-sm" @onclick="CancelEditEndpoint">Cancel</button>
                    }
                </div>
            </div>

            @* List *@
            @if (_allEndpoints.Count > 0)
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>URL</th>
                            <th>API Key</th>
                            <th>Enabled</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ep in _allEndpoints)
                        {
                            <tr>
                                <td>@ep.Name</td>
                                <td style="font-family:monospace;font-size:0.9rem">@ep.BaseUrl</td>
                                <td style="color:var(--text-secondary)">@(string.IsNullOrEmpty(ep.ApiKey) ? "—" : "••••••••")</td>
                                <td>
                                    <span class="state-badge @(ep.IsEnabled ? "running" : "stopped")">
                                        @(ep.IsEnabled ? "Yes" : "No")
                                    </span>
                                </td>
                                <td class="actions">
                                    <button class="btn btn-sm btn-secondary" @onclick="() => StartEditEndpoint(ep)">Edit</button>
                                    <button class="btn btn-sm @(ep.IsEnabled ? "btn-warning" : "btn-success")"
                                            @onclick="() => ToggleEndpointEnabled(ep)">
                                        @(ep.IsEnabled ? "Disable" : "Enable")
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => RemoveEndpoint(ep)">Remove</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p style="color:var(--text-secondary)">No endpoints configured. Add one above to get started.</p>
            }
        </div>
    }

    @if (_selectedEndpoint == null && !_showEndpointManager)
    {
        <div class="section" style="text-align:center;padding:60px 20px">
            @if (_endpoints.Count == 0)
            {
                <p style="color:var(--text-secondary);font-size:1.1rem">
                    No WorldEngine servers configured.
                    <button class="btn btn-primary btn-sm" style="margin-left:8px" @onclick="() => _showEndpointManager = true">Add a Server</button>
                </p>
            }
            else
            {
                <p style="color:var(--text-secondary);font-size:1.1rem">Select a server from the dropdown above to manage encounters.</p>
            }
        </div>
    }

    @if (_selectedEndpoint != null && _showCreateForm)
    {
        <div class="section" style="margin-bottom:20px">
            <h2>Create Profile</h2>
            <div class="inline-form">
                <div class="form-row">
                    <div class="form-group">
                        <label>Area ResRef</label>
                        <input class="form-control" @bind="_newAreaResRef" placeholder="e.g. howling_woods" maxlength="32" />
                    </div>
                    <div class="form-group">
                        <label>Name</label>
                        <input class="form-control" @bind="_newProfileName" placeholder="e.g. Howling Woods Encounters" maxlength="128" />
                    </div>
                    <div class="form-group">
                        <label>Cooldown (s)</label>
                        <input class="form-control" type="number" @bind="_newCooldown" />
                    </div>
                    <div class="form-group">
                        <label>Despawn (s)</label>
                        <input class="form-control" type="number" @bind="_newDespawn" />
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-success" @onclick="CreateProfile" disabled="@_isSaving">Create</button>
                    <button class="btn btn-secondary" @onclick="() => _showCreateForm = false">Cancel</button>
                </div>
            </div>
        </div>
    }

    @if (_selectedEndpoint != null && _isLoading)
    {
        <div class="loading">Loading profiles...</div>
    }
    else if (_selectedEndpoint != null)
    {
        @* ===== Profile List (full width) ===== *@
        <div class="profile-list section">
            <div class="section-header-row">
                <h2>Profiles (@FilteredProfiles.Count of @_profiles.Count)</h2>
                <div class="search-bar">
                    <input class="form-control form-control-sm" type="search"
                           placeholder="Filter by area or name..."
                           @bind="_searchFilter" @bind:event="oninput" />
                </div>
            </div>
            @if (FilteredProfiles.Count == 0 && _profiles.Count > 0)
            {
                <p style="color: var(--text-secondary)">No profiles matching "<strong>@_searchFilter</strong>".</p>
            }
            else if (_profiles.Count == 0)
            {
                <p style="color: var(--text-secondary)">No profiles configured yet.</p>
            }
            else
            {
                <table class="table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Area</th>
                            <th>Active</th>
                            <th>Groups</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in FilteredProfiles)
                        {
                            <tr class="clickable-row" @onclick="() => SelectProfile(p)">
                                <td>@p.Name</td>
                                <td><code>@p.AreaResRef</code></td>
                                <td>
                                    <span class="state-badge @(p.IsActive ? "running" : "stopped")">
                                        @(p.IsActive ? "Active" : "Inactive")
                                    </span>
                                </td>
                                <td>@p.SpawnGroups.Count</td>
                                <td class="actions" @onclick:stopPropagation="true">
                                    @if (p.IsActive)
                                    {
                                        <button class="btn btn-sm btn-warning" @onclick="() => ToggleActive(p)">Deactivate</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-sm btn-success" @onclick="() => ToggleActive(p)">Activate</button>
                                    }
                                    <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteProfile(p)">Delete</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

        @* ===== Profile Detail Modal ===== *@
        @if (_selectedProfile != null)
        {
            <div class="modal-backdrop" @onclick="CloseProfileModal"></div>
            <div class="profile-modal">
                <div class="profile-modal-header">
                    <h2>@_selectedProfile.Name</h2>
                    <button class="btn btn-sm btn-secondary" @onclick="CloseProfileModal">✕ Close</button>
                </div>
                <div class="profile-modal-body">
                    @* --- Profile Settings --- *@
                    <div class="section">
                        <div class="inline-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Name</label>
                                    <input class="form-control" @bind="_editName" />
                                </div>
                                <div class="form-group">
                                    <label>Cooldown (s)</label>
                                    <input class="form-control" type="number" @bind="_editCooldown" />
                                </div>
                                <div class="form-group">
                                    <label>Despawn (s)</label>
                                    <input class="form-control" type="number" @bind="_editDespawn" />
                                </div>
                            </div>
                            <div class="form-actions">
                                <button class="btn btn-primary" @onclick="SaveProfileSettings" disabled="@_isSaving">Save</button>
                            </div>
                        </div>
                    </div>

                    @* --- Spawn Groups --- *@
                    <div class="section">
                        <div class="section-header-row">
                            <h2>Spawn Groups (@_selectedProfile.SpawnGroups.Count)</h2>
                            <button class="btn btn-sm btn-primary" @onclick="() => _showAddGroup = !_showAddGroup">+ Add Group</button>
                        </div>

                        @if (_showAddGroup)
                        {
                            <div class="inline-form" style="margin-bottom:15px;padding:15px;background:var(--bg-input);border-radius:8px">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Group Name</label>
                                        <input class="form-control" @bind="_newGroupName" placeholder="e.g. Wolves - Day" />
                                    </div>
                                    <div class="form-group">
                                        <label>Weight</label>
                                        <input class="form-control" type="number" @bind="_newGroupWeight" />
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-success btn-sm" @onclick="AddGroup" disabled="@_isSaving">Add</button>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => _showAddGroup = false">Cancel</button>
                                </div>
                            </div>
                        }

                        @foreach (var group in _selectedProfile.SpawnGroups)
                        {
                            bool expanded = _expandedGroups.Contains(group.Id);
                            <div class="group-card @(expanded ? "expanded" : "")">
                                <div class="group-card-header" @onclick="() => ToggleGroupExpanded(group.Id)">
                                    <span class="expand-icon">@(expanded ? "▼" : "▶")</span>
                                    <strong>@group.Name</strong>
                                    <span style="color:var(--text-secondary);margin-left:10px">Weight: @group.Weight · @group.Entries.Count entries · @group.Conditions.Count conditions</span>
                                    <div class="group-card-actions" @onclick:stopPropagation="true">
                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteGroup(group)">Delete</button>
                                    </div>
                                </div>
                                @if (expanded)
                                {
                                    <div class="group-card-body">
                                        @* -- Group Name/Weight Edit -- *@
                                        <div class="inline-form" style="margin-bottom:15px">
                                            <div class="form-row">
                                                <div class="form-group">
                                                    <label>Name</label>
                                                    <input class="form-control" value="@group.Name" @onchange="e => UpdateGroupName(group, e)" />
                                                </div>
                                                <div class="form-group">
                                                    <label>Weight</label>
                                                    <input class="form-control" type="number" value="@group.Weight" @onchange="e => UpdateGroupWeight(group, e)" />
                                                </div>
                                            </div>
                                        </div>

                                        @* -- Entries -- *@
                                        <div class="section-header-row" style="margin-top:10px">
                                            <h3>Entries (@group.Entries.Count)</h3>
                                            <button class="btn btn-sm btn-primary" @onclick="() => ToggleAddEntry(group.Id)">+ Add Entry</button>
                                        </div>

                                        @if (_addEntryGroupId == group.Id)
                                        {
                                            <div class="inline-form" style="margin-bottom:10px;padding:10px;background:var(--bg-dark);border-radius:6px">
                                                <div class="form-row">
                                                    <div class="form-group" style="flex:2">
                                                        <label>Creature ResRef</label>
                                                        <input class="form-control form-control-sm" @bind="_newEntryResRef" placeholder="e.g. wolf_01" maxlength="32" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Weight</label>
                                                        <input class="form-control form-control-sm" type="number" @bind="_newEntryWeight" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Min</label>
                                                        <input class="form-control form-control-sm" type="number" @bind="_newEntryMin" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Max</label>
                                                        <input class="form-control form-control-sm" type="number" @bind="_newEntryMax" />
                                                    </div>
                                                </div>
                                                <div class="form-actions">
                                                    <button class="btn btn-success btn-sm" @onclick="() => AddEntry(group.Id)" disabled="@_isSaving">Add</button>
                                                    <button class="btn btn-secondary btn-sm" @onclick="() => _addEntryGroupId = null">Cancel</button>
                                                </div>
                                            </div>
                                        }

                                        @if (group.Entries.Count > 0)
                                        {
                                            <table class="table table-compact">
                                                <thead>
                                                    <tr>
                                                        <th>Creature ResRef</th>
                                                        <th style="width:80px">Weight</th>
                                                        <th style="width:70px">Min</th>
                                                        <th style="width:70px">Max</th>
                                                        <th style="width:60px"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var entry in group.Entries)
                                                    {
                                                        <tr>
                                                            <td>
                                                                <input class="form-control form-control-sm" value="@entry.CreatureResRef"
                                                                       @onchange="e => UpdateEntryField(entry, nameof(entry.CreatureResRef), e)" />
                                                            </td>
                                                            <td>
                                                                <input class="form-control form-control-sm" type="number" value="@entry.RelativeWeight"
                                                                       @onchange="e => UpdateEntryField(entry, nameof(entry.RelativeWeight), e)" />
                                                            </td>
                                                            <td>
                                                                <input class="form-control form-control-sm" type="number" value="@entry.MinCount"
                                                                       @onchange="e => UpdateEntryField(entry, nameof(entry.MinCount), e)" />
                                                            </td>
                                                            <td>
                                                                <input class="form-control form-control-sm" type="number" value="@entry.MaxCount"
                                                                       @onchange="e => UpdateEntryField(entry, nameof(entry.MaxCount), e)" />
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEntry(entry)">✕</button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <p style="color:var(--text-secondary);font-size:0.9rem">No entries — add creature resrefs above.</p>
                                        }

                                        @* -- Conditions -- *@
                                        <div class="section-header-row" style="margin-top:15px">
                                            <h3>Conditions (@group.Conditions.Count)</h3>
                                            <button class="btn btn-sm btn-primary" @onclick="() => ToggleAddCondition(group.Id)">+ Add Condition</button>
                                        </div>

                                        @if (_addConditionGroupId == group.Id)
                                        {
                                            <div class="inline-form" style="margin-bottom:10px;padding:10px;background:var(--bg-dark);border-radius:6px">
                                                <div class="form-row">
                                                    <div class="form-group">
                                                        <label>Type</label>
                                                        <select class="form-control form-control-sm" @bind="_newConditionType">
                                                            @foreach (SpawnConditionType t in Enum.GetValues<SpawnConditionType>())
                                                            {
                                                                <option value="@t">@t</option>
                                                            }
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Operator</label>
                                                        <input class="form-control form-control-sm" @bind="_newConditionOp" placeholder="e.g. >=" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label>Value</label>
                                                        <input class="form-control form-control-sm" @bind="_newConditionValue" placeholder="e.g. 06:00-18:00" />
                                                    </div>
                                                </div>
                                                <div class="form-actions">
                                                    <button class="btn btn-success btn-sm" @onclick="() => AddCondition(group.Id)" disabled="@_isSaving">Add</button>
                                                    <button class="btn btn-secondary btn-sm" @onclick="() => _addConditionGroupId = null">Cancel</button>
                                                </div>
                                            </div>
                                        }

                                        @if (group.Conditions.Count == 0)
                                        {
                                            <p style="color:var(--text-secondary);font-size:0.9rem">No conditions — group is always eligible.</p>
                                        }
                                        else
                                        {
                                            <table class="table table-compact">
                                                <thead>
                                                    <tr>
                                                        <th>Type</th>
                                                        <th>Operator</th>
                                                        <th>Value</th>
                                                        <th style="width:60px"></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var cond in group.Conditions)
                                                    {
                                                        <tr>
                                                            <td>
                                                                <select class="form-control form-control-sm" value="@cond.Type"
                                                                        @onchange="e => UpdateConditionField(cond, nameof(cond.Type), e)">
                                                                    @foreach (SpawnConditionType t in Enum.GetValues<SpawnConditionType>())
                                                                    {
                                                                        <option value="@t" selected="@(t == cond.Type)">@t</option>
                                                                    }
                                                                </select>
                                                            </td>
                                                            <td>
                                                                <input class="form-control form-control-sm" value="@cond.Operator"
                                                                       @onchange="e => UpdateConditionField(cond, nameof(cond.Operator), e)" />
                                                            </td>
                                                            <td>
                                                                <input class="form-control form-control-sm" value="@cond.Value"
                                                                       @onchange="e => UpdateConditionField(cond, nameof(cond.Value), e)" />
                                                            </td>
                                                            <td>
                                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteCondition(cond)">✕</button>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    @* --- Bonuses --- *@
                    <div class="section">
                        <div class="section-header-row">
                            <h2>Profile Bonuses (@_selectedProfile.Bonuses.Count)</h2>
                            <button class="btn btn-sm btn-primary" @onclick="() => _showAddBonus = !_showAddBonus">+ Add Bonus</button>
                        </div>

                        @if (_showAddBonus)
                        {
                            <div class="inline-form" style="margin-bottom:15px;padding:15px;background:var(--bg-input);border-radius:8px">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input class="form-control" @bind="_newBonusName" placeholder="e.g. Extra HP" />
                                    </div>
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select class="form-control" @bind="_newBonusType">
                                            @foreach (SpawnBonusType t in Enum.GetValues<SpawnBonusType>())
                                            {
                                                <option value="@t">@t</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Value</label>
                                        <input class="form-control" type="number" @bind="_newBonusValue" />
                                    </div>
                                    <div class="form-group">
                                        <label>Duration (s)</label>
                                        <input class="form-control" type="number" @bind="_newBonusDuration" />
                                        <small class="form-text">0 = permanent</small>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button class="btn btn-success btn-sm" @onclick="AddBonus" disabled="@_isSaving">Add</button>
                                    <button class="btn btn-secondary btn-sm" @onclick="() => _showAddBonus = false">Cancel</button>
                                </div>
                            </div>
                        }

                        @if (_selectedProfile.Bonuses.Count > 0)
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Value</th>
                                        <th>Duration</th>
                                        <th>Active</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var bonus in _selectedProfile.Bonuses)
                                    {
                                        <tr>
                                            <td>@bonus.Name</td>
                                            <td>@bonus.Type</td>
                                            <td>@bonus.Value</td>
                                            <td>@(bonus.DurationSeconds == 0 ? "Permanent" : $"{bonus.DurationSeconds}s")</td>
                                            <td>
                                                <span class="state-badge @(bonus.IsActive ? "running" : "stopped")">
                                                    @(bonus.IsActive ? "Active" : "Off")
                                                </span>
                                            </td>
                                            <td class="actions">
                                                <button class="btn btn-sm @(bonus.IsActive ? "btn-warning" : "btn-success")"
                                                        @onclick="() => ToggleBonusActive(bonus)">
                                                    @(bonus.IsActive ? "Disable" : "Enable")
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteBonus(bonus)">Delete</button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <p style="color:var(--text-secondary)">No bonuses configured.</p>
                        }
                    </div>

                    @* --- Mini-Boss --- *@
                    <div class="section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h2 class="mb-0">Mini-Boss</h2>
                            @if (_selectedProfile.MiniBoss == null)
                            {
                                <button class="btn btn-sm btn-outline-warning" @onclick="() => _showAddMiniBoss = !_showAddMiniBoss">
                                    @(_showAddMiniBoss ? "Cancel" : "+ Add Mini-Boss")
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="DeleteMiniBoss" disabled="@_isSaving">Delete Mini-Boss</button>
                            }
                        </div>

                        @if (_selectedProfile.MiniBoss == null)
                        {
                            @if (_showAddMiniBoss)
                            {
                                <div class="row g-2 align-items-end mb-3">
                                    <div class="col-5">
                                        <label class="form-label">Creature ResRef</label>
                                        <input class="form-control form-control-sm" @bind="_newMiniBossResRef" placeholder="e.g. nw_werewolf" />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">Spawn Chance %</label>
                                        <input type="number" class="form-control form-control-sm" @bind="_newMiniBossChance" min="0" max="100" />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-warning" @onclick="CreateMiniBoss" disabled="@_isSaving">Save</button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <p style="color:var(--text-secondary)">No mini-boss configured.</p>
                            }
                        }
                        else
                        {
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Creature ResRef</th>
                                        <th style="width:140px">Spawn Chance %</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <input class="form-control form-control-sm"
                                                   value="@_selectedProfile.MiniBoss.CreatureResRef"
                                                   @onchange="e => UpdateMiniBossField(e.Value?.ToString(), null)" />
                                        </td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm" min="0" max="100"
                                                   value="@_selectedProfile.MiniBoss.SpawnChancePercent"
                                                   @onchange="e => UpdateMiniBossField(null, int.TryParse(e.Value?.ToString(), out var v) ? v : null)" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            @* Mini-Boss Bonuses *@
                            <h3 class="mt-3">Mini-Boss Bonuses</h3>
                            @if (_selectedProfile.MiniBoss.Bonuses.Any())
                            {
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Value</th>
                                            <th>Duration (s)</th>
                                            <th>Active</th>
                                            <th style="width:50px"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var b in _selectedProfile.MiniBoss.Bonuses)
                                        {
                                            <tr>
                                                <td><input class="form-control form-control-sm" value="@b.Name"
                                                           @onchange="e => UpdateMiniBossBonusField(b, nameof(SpawnBonusDto.Name), e)" /></td>
                                                <td>
                                                    <select class="form-select form-select-sm" value="@b.Type"
                                                            @onchange="e => UpdateMiniBossBonusField(b, nameof(SpawnBonusDto.Type), e)">
                                                        @foreach (var t in Enum.GetValues<SpawnBonusType>())
                                                        {
                                                            <option value="@t" selected="@(t == b.Type)">@t</option>
                                                        }
                                                    </select>
                                                </td>
                                                <td><input type="number" class="form-control form-control-sm" value="@b.Value"
                                                           @onchange="e => UpdateMiniBossBonusField(b, nameof(SpawnBonusDto.Value), e)" /></td>
                                                <td><input type="number" class="form-control form-control-sm" value="@b.DurationSeconds"
                                                           @onchange="e => UpdateMiniBossBonusField(b, nameof(SpawnBonusDto.DurationSeconds), e)" /></td>
                                                <td>
                                                    <input type="checkbox" checked="@b.IsActive"
                                                           @onchange="() => ToggleMiniBossBonusActive(b)" />
                                                </td>
                                                <td><button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteMiniBossBonus(b)">✕</button></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p style="color:var(--text-secondary)">No bonuses on mini-boss.</p>
                            }

                            <div class="row g-2 align-items-end mt-1">
                                <div class="col-3">
                                    <input class="form-control form-control-sm" @bind="_newMbBonusName" placeholder="Name" />
                                </div>
                                <div class="col-2">
                                    <select class="form-select form-select-sm" @bind="_newMbBonusType">
                                        @foreach (var t in Enum.GetValues<SpawnBonusType>())
                                        {
                                            <option value="@t">@t</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-2">
                                    <input type="number" class="form-control form-control-sm" @bind="_newMbBonusValue" placeholder="Value" />
                                </div>
                                <div class="col-2">
                                    <input type="number" class="form-control form-control-sm" @bind="_newMbBonusDuration" placeholder="Duration" />
                                </div>
                                <div class="col-auto">
                                    <button class="btn btn-sm btn-outline-warning" @onclick="AddMiniBossBonus" disabled="@_isSaving">+ Bonus</button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    }

    @* ==================== Mutations Management ==================== *@
    @if (_selectedEndpoint != null)
    {
        <div class="section mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="mb-0">Mutation Templates</h2>
                <div>
                    <button class="btn btn-sm btn-outline-warning" @onclick="() => _showAddMutation = !_showAddMutation">
                        @(_showAddMutation ? "Cancel" : "+ New Mutation")
                    </button>
                    <button class="btn btn-sm btn-secondary ms-1" @onclick="LoadMutations" disabled="@_isLoadingMutations">Refresh</button>
                </div>
            </div>

            @if (_showAddMutation)
            {
                <div class="row g-2 align-items-end mb-3">
                    <div class="col-3">
                        <label class="form-label">Prefix</label>
                        <input class="form-control form-control-sm" @bind="_newMutPrefix" placeholder="e.g. Frenzied" />
                    </div>
                    <div class="col-3">
                        <label class="form-label">Description</label>
                        <input class="form-control form-control-sm" @bind="_newMutDescription" placeholder="Optional description" />
                    </div>
                    <div class="col-2">
                        <label class="form-label">Chance %</label>
                        <input type="number" class="form-control form-control-sm" @bind="_newMutChance" min="0" max="100" />
                    </div>
                    <div class="col-auto">
                        <button class="btn btn-sm btn-warning" @onclick="CreateMutation" disabled="@_isSaving">Save</button>
                    </div>
                </div>
            }

            @if (_isLoadingMutations)
            {
                <p>Loading mutations...</p>
            }
            else if (_mutations.Count == 0)
            {
                <p style="color:var(--text-secondary)">No mutation templates defined.</p>
            }
            else
            {
                @foreach (var mut in _mutations)
                {
                    <div class="card mb-3" style="background:var(--bg-surface); border-color:var(--border-color);">
                        <div class="card-header d-flex justify-content-between align-items-center"
                             style="cursor:pointer; background:var(--bg-card); border-color:var(--border-color);"
                             @onclick="() => ToggleMutationExpand(mut.Id)">
                            <div>
                                <strong style="color:var(--accent-amber);">@mut.Prefix</strong>
                                <span class="ms-2" style="color:var(--text-secondary)">@(mut.Description ?? "")</span>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge" style="background:var(--accent-amber); color:var(--bg-primary)">@mut.SpawnChancePercent%</span>
                                <input type="checkbox" checked="@mut.IsActive"
                                       @onchange="() => ToggleMutationActive(mut)" />
                                <button class="btn btn-sm btn-outline-danger" @onclick:stopPropagation="true"
                                        @onclick="() => DeleteMutation(mut)">✕</button>
                            </div>
                        </div>

                        @if (_expandedMutations.Contains(mut.Id))
                        {
                            <div class="card-body" style="border-top:1px solid var(--border-color);">
                                @* Editable mutation fields *@
                                <div class="row g-2 align-items-end mb-3">
                                    <div class="col-3">
                                        <label class="form-label">Prefix</label>
                                        <input class="form-control form-control-sm" value="@mut.Prefix"
                                               @onchange='e => UpdateMutationField(mut, "Prefix", e)' />
                                    </div>
                                    <div class="col-3">
                                        <label class="form-label">Description</label>
                                        <input class="form-control form-control-sm" value="@(mut.Description ?? "")"
                                               @onchange='e => UpdateMutationField(mut, "Description", e)' />
                                    </div>
                                    <div class="col-2">
                                        <label class="form-label">Chance %</label>
                                        <input type="number" class="form-control form-control-sm" min="0" max="100"
                                               value="@mut.SpawnChancePercent"
                                               @onchange='e => UpdateMutationField(mut, "SpawnChancePercent", e)' />
                                    </div>
                                </div>

                                @* Effects table *@
                                <h3 class="mt-2">Effects</h3>
                                @if (mut.Effects.Any())
                                {
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Type</th>
                                                <th>Value</th>
                                                <th>Ability</th>
                                                <th>Damage Type</th>
                                                <th>Duration (s)</th>
                                                <th>Active</th>
                                                <th style="width:50px"></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var fx in mut.Effects)
                                            {
                                                <tr>
                                                    <td>
                                                        <select class="form-select form-select-sm" value="@fx.Type"
                                                                @onchange='e => UpdateEffectField(fx, "Type", e)'>
                                                            @foreach (var t in Enum.GetValues<MutationEffectType>())
                                                            {
                                                                <option value="@t" selected="@(t == fx.Type)">@t</option>
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm" value="@fx.Value"
                                                               @onchange='e => UpdateEffectField(fx, "Value", e)' />
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm"
                                                                value="@(fx.AbilityType?.ToString() ?? "")"
                                                                @onchange='e => UpdateEffectField(fx, "AbilityType", e)'>
                                                            <option value="">—</option>
                                                            @foreach (var a in Enum.GetValues<NwnAbilityType>())
                                                            {
                                                                <option value="@a" selected="@(a == fx.AbilityType)">@a</option>
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select class="form-select form-select-sm"
                                                                value="@(fx.DamageType?.ToString() ?? "")"
                                                                @onchange='e => UpdateEffectField(fx, "DamageType", e)'>
                                                            <option value="">—</option>
                                                            @foreach (var d in Enum.GetValues<NwnDamageType>())
                                                            {
                                                                <option value="@d" selected="@(d == fx.DamageType)">@d</option>
                                                            }
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control form-control-sm" value="@fx.DurationSeconds"
                                                               @onchange='e => UpdateEffectField(fx, "DurationSeconds", e)' />
                                                    </td>
                                                    <td>
                                                        <input type="checkbox" checked="@fx.IsActive"
                                                               @onchange="() => ToggleEffectActive(fx)" />
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteEffect(fx)">✕</button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                                else
                                {
                                    <p style="color:var(--text-secondary)">No effects. Add one below.</p>
                                }

                                @* Add effect row *@
                                <div class="row g-2 align-items-end mt-1">
                                    <div class="col-2">
                                        <select class="form-select form-select-sm" @bind="_newFxType">
                                            @foreach (var t in Enum.GetValues<MutationEffectType>())
                                            {
                                                <option value="@t">@t</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-1">
                                        <input type="number" class="form-control form-control-sm" @bind="_newFxValue" placeholder="Val" />
                                    </div>
                                    <div class="col-2">
                                        <select class="form-select form-select-sm" @bind="_newFxAbility">
                                            <option value="">— Ability —</option>
                                            @foreach (var a in Enum.GetValues<NwnAbilityType>())
                                            {
                                                <option value="@a">@a</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-2">
                                        <select class="form-select form-select-sm" @bind="_newFxDamageType">
                                            <option value="">— Dmg Type —</option>
                                            @foreach (var d in Enum.GetValues<NwnDamageType>())
                                            {
                                                <option value="@d">@d</option>
                                            }
                                        </select>
                                    </div>
                                    <div class="col-1">
                                        <input type="number" class="form-control form-control-sm" @bind="_newFxDuration" placeholder="Dur" />
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-outline-warning" @onclick="() => AddEffect(mut.Id)" disabled="@_isSaving">+ Effect</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    }
</div>

@code {
    // ===== Endpoint Management =====
    private List<WorldEngineEndpoint> _allEndpoints = [];
    private List<WorldEngineEndpoint> _endpoints = []; // enabled only
    private WorldEngineEndpoint? _selectedEndpoint;
    private bool _showEndpointManager;
    private bool _isSavingEndpoint;
    private string _epName = "";
    private string _epUrl = "";
    private string _epApiKey = "";
    private Guid? _editingEndpointId;

    // ===== Encounter State =====
    private List<SpawnProfileDto> _profiles = [];
    private SpawnProfileDto? _selectedProfile;
    private HashSet<Guid> _expandedGroups = [];
    private string _searchFilter = "";

    private bool _isLoading;
    private bool _isSaving;
    private bool _isRefreshingCache;
    private string? _error;
    private string? _success;

    // ===== Filtered Profile List =====
    private List<SpawnProfileDto> FilteredProfiles => string.IsNullOrWhiteSpace(_searchFilter)
        ? _profiles
        : _profiles.Where(p =>
            p.Name.Contains(_searchFilter, StringComparison.OrdinalIgnoreCase) ||
            p.AreaResRef.Contains(_searchFilter, StringComparison.OrdinalIgnoreCase))
        .ToList();

    // ===== Create Profile Form =====
    private bool _showCreateForm;
    private string _newAreaResRef = "";
    private string _newProfileName = "";
    private int _newCooldown = 900;
    private int _newDespawn = 600;

    // ===== Edit Profile =====
    private string _editName = "";
    private int _editCooldown;
    private int _editDespawn;

    // ===== Add Group Form =====
    private bool _showAddGroup;
    private string _newGroupName = "";
    private int _newGroupWeight = 1;

    // ===== Add Bonus Form =====
    private bool _showAddBonus;
    private string _newBonusName = "";
    private SpawnBonusType _newBonusType = SpawnBonusType.TempHP;
    private int _newBonusValue = 10;
    private int _newBonusDuration;

    // ===== Add Entry Form =====
    private Guid? _addEntryGroupId;
    private string _newEntryResRef = "";
    private int _newEntryWeight = 1;
    private int _newEntryMin = 1;
    private int _newEntryMax = 4;

    // ===== Add Condition Form =====
    private Guid? _addConditionGroupId;
    private SpawnConditionType _newConditionType = SpawnConditionType.TimeOfDay;
    private string _newConditionOp = "";
    private string _newConditionValue = "";

    // ===== Mini-Boss Form =====
    private bool _showAddMiniBoss;
    private string _newMiniBossResRef = "";
    private int _newMiniBossChance = 5;
    private string _newMbBonusName = "";
    private SpawnBonusType _newMbBonusType = SpawnBonusType.TempHP;
    private int _newMbBonusValue = 10;
    private int _newMbBonusDuration;

    // ===== Mutations =====
    private List<MutationTemplateDto> _mutations = [];
    private HashSet<Guid> _expandedMutations = [];
    private bool _isLoadingMutations;
    private bool _showAddMutation;
    private string _newMutPrefix = "";
    private string? _newMutDescription;
    private int _newMutChance = 10;

    // ===== Add Effect Form =====
    private MutationEffectType _newFxType = MutationEffectType.AbilityBonus;
    private int _newFxValue = 2;
    private string? _newFxAbility;
    private string? _newFxDamageType;
    private int _newFxDuration;

    // ===== Lifecycle =====

    protected override async Task OnInitializedAsync()
    {
        await RefreshEndpoints();
    }

    // ===== Endpoint CRUD =====

    private async Task RefreshEndpoints()
    {
        try
        {
            _allEndpoints = (await EndpointService.GetAllEndpointsAsync()).ToList();
            _endpoints = _allEndpoints.Where(e => e.IsEnabled).ToList();

            // Re-validate current selection
            if (_selectedEndpoint != null && _endpoints.All(e => e.Id != _selectedEndpoint.Id))
            {
                _selectedEndpoint = null;
                Api.SelectEndpoint(null);
                _profiles = [];
            }
        }
        catch (Exception ex)
        {
            _error = $"Failed to load endpoints: {ex.Message}";
            Logger.LogError(ex, "Failed to load WorldEngine endpoints");
        }
    }

    private async Task OnEndpointChanged(ChangeEventArgs e)
    {
        var idStr = e.Value?.ToString();
        if (string.IsNullOrEmpty(idStr))
        {
            _selectedEndpoint = null;
            Api.SelectEndpoint(null);
            _profiles = [];
            return;
        }

        if (!Guid.TryParse(idStr, out var id)) return;

        _selectedEndpoint = _endpoints.FirstOrDefault(ep => ep.Id == id);
        if (_selectedEndpoint == null) return;

        Api.SelectEndpoint(_selectedEndpoint.Id);
        ResetEncounterState();
        await RefreshProfiles();
        await LoadMutations();
    }

    private void ResetEncounterState()
    {
        _selectedProfile = null;
        _expandedGroups.Clear();
        _showCreateForm = false;
        _showAddGroup = false;
        _showAddBonus = false;
        _error = null;
        _success = null;
    }

    private async Task AddEndpoint()
    {
        if (string.IsNullOrWhiteSpace(_epName) || string.IsNullOrWhiteSpace(_epUrl))
        {
            _error = "Name and URL are required.";
            return;
        }

        _isSavingEndpoint = true;
        try
        {
            await EndpointService.AddEndpointAsync(_epName, _epUrl, string.IsNullOrWhiteSpace(_epApiKey) ? null : _epApiKey);
            _success = $"Server '{_epName}' added.";
            _epName = "";
            _epUrl = "";
            _epApiKey = "";
            await RefreshEndpoints();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSavingEndpoint = false; }
    }

    private void StartEditEndpoint(WorldEngineEndpoint ep)
    {
        _editingEndpointId = ep.Id;
        _epName = ep.Name;
        _epUrl = ep.BaseUrl;
        _epApiKey = ep.ApiKey ?? "";
    }

    private void CancelEditEndpoint()
    {
        _editingEndpointId = null;
        _epName = "";
        _epUrl = "";
        _epApiKey = "";
    }

    private async Task SaveEditEndpoint()
    {
        if (_editingEndpointId == null) return;
        _isSavingEndpoint = true;
        try
        {
            bool clearKey = string.IsNullOrWhiteSpace(_epApiKey);
            await EndpointService.UpdateEndpointAsync(_editingEndpointId.Value, _epName, _epUrl, null,
                clearKey ? null : _epApiKey, clearApiKey: clearKey);
            _success = $"Server '{_epName}' updated.";
            CancelEditEndpoint();
            await RefreshEndpoints();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSavingEndpoint = false; }
    }

    private async Task ToggleEndpointEnabled(WorldEngineEndpoint ep)
    {
        try
        {
            await EndpointService.UpdateEndpointAsync(ep.Id, null, null, !ep.IsEnabled);
            await RefreshEndpoints();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task RemoveEndpoint(WorldEngineEndpoint ep)
    {
        try
        {
            await EndpointService.RemoveEndpointAsync(ep.Id);
            _success = $"Server '{ep.Name}' removed.";
            if (_selectedEndpoint?.Id == ep.Id)
            {
                _selectedEndpoint = null;
                Api.SelectEndpoint(null);
                _profiles = [];
            }
            await RefreshEndpoints();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Profile List =====

    private async Task RefreshProfiles()
    {
        _isLoading = true;
        _error = null;
        StateHasChanged();

        try
        {
            _profiles = await Api.GetAllProfilesAsync();

            // Re-select current profile if it still exists
            if (_selectedProfile != null)
            {
                SpawnProfileDto? refreshed = _profiles.FirstOrDefault(p => p.Id == _selectedProfile.Id);
                if (refreshed != null)
                {
                    SelectProfile(refreshed);
                }
                else
                {
                    _selectedProfile = null;
                }
            }
        }
        catch (Exception ex)
        {
            _error = $"Failed to load profiles: {ex.Message}";
            Logger.LogError(ex, "Failed to load encounter profiles");
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectProfile(SpawnProfileDto profile)
    {
        _selectedProfile = profile;
        _editName = profile.Name;
        _editCooldown = profile.CooldownSeconds;
        _editDespawn = profile.DespawnSeconds;
        _showAddGroup = false;
        _showAddBonus = false;
    }

    private void CloseProfileModal()
    {
        _selectedProfile = null;
        _expandedGroups.Clear();
        _showAddGroup = false;
        _showAddBonus = false;
    }

    // ===== Profile CRUD =====

    private async Task CreateProfile()
    {
        if (string.IsNullOrWhiteSpace(_newAreaResRef) || string.IsNullOrWhiteSpace(_newProfileName))
        {
            _error = "Area ResRef and Name are required.";
            return;
        }

        _isSaving = true;
        try
        {
            await Api.CreateProfileAsync(new CreateProfileRequest(
                _newAreaResRef.Trim(), _newProfileName.Trim(), false, _newCooldown, _newDespawn));
            _success = $"Profile '{_newProfileName}' created.";
            _newAreaResRef = "";
            _newProfileName = "";
            _newCooldown = 900;
            _newDespawn = 600;
            _showCreateForm = false;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task SaveProfileSettings()
    {
        if (_selectedProfile == null) return;
        _isSaving = true;
        try
        {
            await Api.UpdateProfileAsync(_selectedProfile.Id, new UpdateProfileRequest(
                _editName, null, _editCooldown, _editDespawn));
            _success = "Profile settings saved.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task ToggleActive(SpawnProfileDto profile)
    {
        try
        {
            if (profile.IsActive)
                await Api.DeactivateProfileAsync(profile.Id);
            else
                await Api.ActivateProfileAsync(profile.Id);
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task DeleteProfile(SpawnProfileDto profile)
    {
        try
        {
            await Api.DeleteProfileAsync(profile.Id);
            if (_selectedProfile?.Id == profile.Id) _selectedProfile = null;
            _success = $"Profile '{profile.Name}' deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Group CRUD =====

    private void ToggleGroupExpanded(Guid groupId)
    {
        if (!_expandedGroups.Remove(groupId))
            _expandedGroups.Add(groupId);
    }

    private async Task AddGroup()
    {
        if (_selectedProfile == null || string.IsNullOrWhiteSpace(_newGroupName)) return;
        _isSaving = true;
        try
        {
            await Api.AddGroupAsync(_selectedProfile.Id,
                new CreateGroupRequest(_newGroupName.Trim(), _newGroupWeight));
            _success = $"Group '{_newGroupName}' added.";
            _newGroupName = "";
            _newGroupWeight = 1;
            _showAddGroup = false;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task UpdateGroupName(SpawnGroupDto group, ChangeEventArgs e)
    {
        string? newName = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(newName) || newName == group.Name) return;
        try
        {
            await Api.UpdateGroupAsync(group.Id, new UpdateGroupRequest(Name: newName));
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task UpdateGroupWeight(SpawnGroupDto group, ChangeEventArgs e)
    {
        if (!int.TryParse(e.Value?.ToString(), out int weight) || weight == group.Weight) return;
        try
        {
            await Api.UpdateGroupAsync(group.Id, new UpdateGroupRequest(Weight: weight));
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task DeleteGroup(SpawnGroupDto group)
    {
        try
        {
            await Api.DeleteGroupAsync(group.Id);
            _expandedGroups.Remove(group.Id);
            _success = $"Group '{group.Name}' deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Entry CRUD =====

    private void ToggleAddEntry(Guid groupId)
    {
        if (_addEntryGroupId == groupId)
        {
            _addEntryGroupId = null;
        }
        else
        {
            _addEntryGroupId = groupId;
            _newEntryResRef = "";
            _newEntryWeight = 1;
            _newEntryMin = 1;
            _newEntryMax = 4;
        }
    }

    private async Task AddEntry(Guid groupId)
    {
        if (string.IsNullOrWhiteSpace(_newEntryResRef)) return;
        _isSaving = true;
        try
        {
            await Api.AddEntryAsync(groupId,
                new CreateEntryRequest(_newEntryResRef.Trim(), _newEntryWeight, _newEntryMin, _newEntryMax));
            _success = $"Entry '{_newEntryResRef}' added.";
            _addEntryGroupId = null;
            _newEntryResRef = "";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task DeleteEntry(SpawnEntryDto entry)
    {
        try
        {
            await Api.DeleteEntryAsync(entry.Id);
            _success = $"Entry '{entry.CreatureResRef}' deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task UpdateEntryField(SpawnEntryDto entry, string field, ChangeEventArgs e)
    {
        string? val = e.Value?.ToString();
        if (string.IsNullOrEmpty(val)) return;

        try
        {
            UpdateEntryRequest req = field switch
            {
                nameof(SpawnEntryDto.CreatureResRef) => new UpdateEntryRequest(CreatureResRef: val),
                nameof(SpawnEntryDto.RelativeWeight) when int.TryParse(val, out int w) => new UpdateEntryRequest(RelativeWeight: w),
                nameof(SpawnEntryDto.MinCount) when int.TryParse(val, out int min) => new UpdateEntryRequest(MinCount: min),
                nameof(SpawnEntryDto.MaxCount) when int.TryParse(val, out int max) => new UpdateEntryRequest(MaxCount: max),
                _ => throw new ArgumentException($"Unknown field: {field}")
            };

            await Api.UpdateEntryAsync(entry.Id, req);
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Condition CRUD =====

    private void ToggleAddCondition(Guid groupId)
    {
        if (_addConditionGroupId == groupId)
        {
            _addConditionGroupId = null;
        }
        else
        {
            _addConditionGroupId = groupId;
            _newConditionType = SpawnConditionType.TimeOfDay;
            _newConditionOp = "";
            _newConditionValue = "";
        }
    }

    private async Task AddCondition(Guid groupId)
    {
        if (string.IsNullOrWhiteSpace(_newConditionOp)) return;
        _isSaving = true;
        try
        {
            await Api.AddConditionAsync(groupId,
                new CreateConditionRequest(_newConditionType, _newConditionOp.Trim(), _newConditionValue.Trim()));
            _success = "Condition added.";
            _addConditionGroupId = null;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task DeleteCondition(SpawnConditionDto condition)
    {
        try
        {
            await Api.DeleteConditionAsync(condition.Id);
            _success = "Condition deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task UpdateConditionField(SpawnConditionDto condition, string field, ChangeEventArgs e)
    {
        string? val = e.Value?.ToString();
        if (string.IsNullOrEmpty(val)) return;

        try
        {
            UpdateConditionRequest req = field switch
            {
                nameof(SpawnConditionDto.Type) when Enum.TryParse<SpawnConditionType>(val, out var t) => new UpdateConditionRequest(Type: t),
                nameof(SpawnConditionDto.Operator) => new UpdateConditionRequest(Operator: val),
                nameof(SpawnConditionDto.Value) => new UpdateConditionRequest(Value: val),
                _ => throw new ArgumentException($"Unknown field: {field}")
            };

            await Api.UpdateConditionAsync(condition.Id, req);
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Bonus CRUD =====

    private async Task AddBonus()
    {
        if (_selectedProfile == null || string.IsNullOrWhiteSpace(_newBonusName)) return;
        _isSaving = true;
        try
        {
            await Api.AddBonusAsync(_selectedProfile.Id,
                new CreateBonusRequest(_newBonusName.Trim(), _newBonusType, _newBonusValue, _newBonusDuration));
            _success = $"Bonus '{_newBonusName}' added.";
            _newBonusName = "";
            _newBonusValue = 10;
            _newBonusDuration = 0;
            _showAddBonus = false;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task ToggleBonusActive(SpawnBonusDto bonus)
    {
        try
        {
            await Api.UpdateBonusAsync(bonus.Id, new UpdateBonusRequest(IsActive: !bonus.IsActive));
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task DeleteBonus(SpawnBonusDto bonus)
    {
        try
        {
            await Api.DeleteBonusAsync(bonus.Id);
            _success = $"Bonus '{bonus.Name}' deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Mini-Boss CRUD =====

    private async Task CreateMiniBoss()
    {
        if (_selectedProfile == null || string.IsNullOrWhiteSpace(_newMiniBossResRef)) return;
        _isSaving = true;
        try
        {
            await Api.CreateMiniBossAsync(_selectedProfile.Id,
                new CreateMiniBossRequest(_newMiniBossResRef.Trim(), _newMiniBossChance));
            _success = "Mini-boss created.";
            _newMiniBossResRef = "";
            _newMiniBossChance = 5;
            _showAddMiniBoss = false;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task UpdateMiniBossField(string? resref, int? chance)
    {
        if (_selectedProfile == null) return;
        try
        {
            await Api.UpdateMiniBossAsync(_selectedProfile.Id,
                new UpdateMiniBossRequest(resref, chance));
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task DeleteMiniBoss()
    {
        if (_selectedProfile == null) return;
        _isSaving = true;
        try
        {
            await Api.DeleteMiniBossAsync(_selectedProfile.Id);
            _success = "Mini-boss removed.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task AddMiniBossBonus()
    {
        if (_selectedProfile?.MiniBoss == null || string.IsNullOrWhiteSpace(_newMbBonusName)) return;
        _isSaving = true;
        try
        {
            await Api.AddMiniBossBonusAsync(_selectedProfile.MiniBoss.Id,
                new CreateBonusRequest(_newMbBonusName.Trim(), _newMbBonusType, _newMbBonusValue, _newMbBonusDuration));
            _success = $"Mini-boss bonus '{_newMbBonusName}' added.";
            _newMbBonusName = "";
            _newMbBonusValue = 10;
            _newMbBonusDuration = 0;
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task UpdateMiniBossBonusField(SpawnBonusDto bonus, string field, ChangeEventArgs e)
    {
        string? val = e.Value?.ToString();
        if (string.IsNullOrEmpty(val)) return;

        try
        {
            UpdateBonusRequest req = field switch
            {
                nameof(SpawnBonusDto.Name) => new UpdateBonusRequest(Name: val),
                nameof(SpawnBonusDto.Type) when Enum.TryParse<SpawnBonusType>(val, out var t) => new UpdateBonusRequest(Type: t),
                nameof(SpawnBonusDto.Value) when int.TryParse(val, out int v) => new UpdateBonusRequest(Value: v),
                nameof(SpawnBonusDto.DurationSeconds) when int.TryParse(val, out int d) => new UpdateBonusRequest(DurationSeconds: d),
                _ => throw new ArgumentException($"Unknown field: {field}")
            };

            await Api.UpdateBonusAsync(bonus.Id, req);
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task ToggleMiniBossBonusActive(SpawnBonusDto bonus)
    {
        try
        {
            await Api.UpdateBonusAsync(bonus.Id, new UpdateBonusRequest(IsActive: !bonus.IsActive));
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    private async Task DeleteMiniBossBonus(SpawnBonusDto bonus)
    {
        try
        {
            await Api.DeleteBonusAsync(bonus.Id);
            _success = $"Mini-boss bonus '{bonus.Name}' deleted.";
            await RefreshProfiles();
        }
        catch (Exception ex) { _error = ex.Message; }
    }

    // ===== Mutations =====

    private async Task LoadMutations()
    {
        _isLoadingMutations = true;
        _error = null;
        StateHasChanged();

        try
        {
            _mutations = await Api.GetAllMutationsAsync();
        }
        catch (Exception ex)
        {
            _error = $"Failed to load mutations: {ex.Message}";
            Logger.LogError(ex, "Failed to load mutation templates");
        }
        finally
        {
            _isLoadingMutations = false;
            StateHasChanged();
        }
    }

    private async Task CreateMutation()
    {
        if (string.IsNullOrWhiteSpace(_newMutPrefix))
        {
            _error = "Prefix is required.";
            return;
        }

        _isSaving = true;
        try
        {
            await Api.CreateMutationAsync(new CreateMutationRequest(
                _newMutPrefix.Trim(),
                _newMutDescription?.Trim(),
                _newMutChance
            ));
            _success = $"Mutation '{_newMutPrefix}' created.";
            _newMutPrefix = "";
            _newMutDescription = null;
            _newMutChance = 10;
            _showAddMutation = false;
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task UpdateMutationField(MutationTemplateDto mut, string field, ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        string prefix = mut.Prefix;
        string? description = mut.Description;
        int chance = mut.SpawnChancePercent;
        bool active = mut.IsActive;

        switch (field)
        {
            case "Prefix": prefix = val; break;
            case "Description": description = string.IsNullOrWhiteSpace(val) ? null : val; break;
            case "SpawnChancePercent": chance = int.TryParse(val, out var c) ? c : chance; break;
        }

        _isSaving = true;
        try
        {
            await Api.UpdateMutationAsync(mut.Id, new UpdateMutationRequest(prefix, description, chance, active));
            _success = $"Mutation '{prefix}' updated.";
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task ToggleMutationActive(MutationTemplateDto mut)
    {
        _isSaving = true;
        try
        {
            await Api.UpdateMutationAsync(mut.Id, new UpdateMutationRequest(
                mut.Prefix, mut.Description, mut.SpawnChancePercent, !mut.IsActive));
            _success = $"Mutation '{mut.Prefix}' {(mut.IsActive ? "deactivated" : "activated")}.";
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task DeleteMutation(MutationTemplateDto mut)
    {
        _isSaving = true;
        try
        {
            await Api.DeleteMutationAsync(mut.Id);
            _success = $"Mutation '{mut.Prefix}' deleted.";
            _expandedMutations.Remove(mut.Id);
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private void ToggleMutationExpand(Guid id)
    {
        if (!_expandedMutations.Remove(id))
            _expandedMutations.Add(id);
    }

    private async Task AddEffect(Guid templateId)
    {
        _isSaving = true;
        try
        {
            NwnAbilityType? abilityType = !string.IsNullOrEmpty(_newFxAbility) && Enum.TryParse<NwnAbilityType>(_newFxAbility, out var a) ? a : null;
            NwnDamageType? damageType = !string.IsNullOrEmpty(_newFxDamageType) && Enum.TryParse<NwnDamageType>(_newFxDamageType, out var d) ? d : null;

            await Api.AddMutationEffectAsync(templateId, new CreateMutationEffectRequest(
                _newFxType, _newFxValue, abilityType, damageType, _newFxDuration
            ));
            _success = "Effect added.";
            _newFxType = MutationEffectType.AbilityBonus;
            _newFxValue = 2;
            _newFxAbility = null;
            _newFxDamageType = null;
            _newFxDuration = 0;
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task UpdateEffectField(MutationEffectDto fx, string field, ChangeEventArgs e)
    {
        var val = e.Value?.ToString() ?? "";
        var type = fx.Type;
        int value = fx.Value;
        NwnAbilityType? abilityType = fx.AbilityType;
        NwnDamageType? damageType = fx.DamageType;
        int duration = fx.DurationSeconds;
        bool active = fx.IsActive;

        switch (field)
        {
            case "Type":
                type = Enum.TryParse<MutationEffectType>(val, out var t) ? t : type;
                break;
            case "Value":
                value = int.TryParse(val, out var v) ? v : value;
                break;
            case "AbilityType":
                abilityType = !string.IsNullOrEmpty(val) && Enum.TryParse<NwnAbilityType>(val, out var ab) ? ab : null;
                break;
            case "DamageType":
                damageType = !string.IsNullOrEmpty(val) && Enum.TryParse<NwnDamageType>(val, out var dt) ? dt : null;
                break;
            case "DurationSeconds":
                duration = int.TryParse(val, out var dur) ? dur : duration;
                break;
        }

        _isSaving = true;
        try
        {
            await Api.UpdateMutationEffectAsync(fx.Id, new UpdateMutationEffectRequest(
                type, value, abilityType, damageType, duration, active));
            _success = "Effect updated.";
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task ToggleEffectActive(MutationEffectDto fx)
    {
        _isSaving = true;
        try
        {
            await Api.UpdateMutationEffectAsync(fx.Id, new UpdateMutationEffectRequest(
                fx.Type, fx.Value, fx.AbilityType, fx.DamageType, fx.DurationSeconds, !fx.IsActive));
            _success = $"Effect {(fx.IsActive ? "deactivated" : "activated")}.";
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    private async Task DeleteEffect(MutationEffectDto fx)
    {
        _isSaving = true;
        try
        {
            await Api.DeleteMutationEffectAsync(fx.Id);
            _success = "Effect deleted.";
            await LoadMutations();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _isSaving = false; }
    }

    // ===== Cache =====

    private async Task RefreshCache()
    {
        _isRefreshingCache = true;
        try
        {
            await Api.RefreshCacheAsync();
            _success = "Encounter cache refreshed successfully.";
        }
        catch (Exception ex) { _error = $"Cache refresh failed: {ex.Message}"; }
        finally { _isRefreshingCache = false; }
    }
}
