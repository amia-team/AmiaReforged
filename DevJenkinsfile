pipeline{
    agent any

    parameters {
        string(name: 'DEV_SERVER_BASE', description: 'Base path for dev server (e.g. /home/amia/dev_server/server)')
        string(name: 'STOP_SCRIPT', description: 'Stop script name (e.g. stop-dev.sh)')
        string(name: 'START_SCRIPT', description: 'Start script name (e.g. start-dev.sh)')
        string(name: 'SERVER_LABEL', description: 'Label for discord notifications (e.g. Dev Server 1)')
        string(name: 'webhookURL', description: 'Discord webhook URL for build notifications')
        booleanParam(name: 'DeployAll', defaultValue: false, description: 'Deploy all plugins')
        booleanParam(name: 'DeployCore', defaultValue: false, description: 'Deploy Core plugin only')
        booleanParam(name: 'DeploySystem', defaultValue: false, description: 'Deploy System plugin only')
        booleanParam(name: 'DeployClasses', defaultValue: false, description: 'Deploy Classes plugin only')
        booleanParam(name: 'DeployRaces', defaultValue: false, description: 'Deploy Races plugin only')
        booleanParam(name: 'DeployDms', defaultValue: false, description: 'Deploy DMS plugin only')
        booleanParam(name: 'DeployPwEngine', defaultValue: false, description: 'Deploy PwEngine plugin only')
    }

    stages {
        stage('Validate') {
            steps {
                script {
                    if (!params.DEV_SERVER_BASE?.trim()) {
                        error "DEV_SERVER_BASE parameter is required but was not set."
                    }
                    if (!params.STOP_SCRIPT?.trim()) {
                        error "STOP_SCRIPT parameter is required but was not set."
                    }
                    if (!params.START_SCRIPT?.trim()) {
                        error "START_SCRIPT parameter is required but was not set."
                    }
                }
            }
        }
        stage('Build') {
            steps {
                echo 'Building..'
                 script {
                    sh "chown -R jenkins.jenkins ${WORKSPACE}"
                    sh "chmod +x ${params.STOP_SCRIPT}"
                    sh "bash ${params.STOP_SCRIPT}"
                }
            }
        }
        stage('Deploy') {
            when {
                    expression {
                        return params.DeployAll == true
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.Core --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Core/"
                sh "dotnet publish AmiaReforged.System --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.System/"
                sh "dotnet publish AmiaReforged.Classes --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Classes/"
                sh "dotnet publish AmiaReforged.Races --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Races/"
                sh "dotnet publish AmiaReforged.DMS --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.DMS/"
                sh "dotnet publish AmiaReforged.PwEngine --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.PwEngine/"
            }
        }
        stage('Deploy Core') {
            when {
                    expression {
                        return params.DeployCore == true && params.DeployAll == false
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.Core --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Core/"
            }
        }
        stage('Deploy System') {
			when {
					expression {
						return params.DeploySystem == true && params.DeployAll == false
					}
			}
			steps {
				echo 'Deploying....'

				sh "dotnet publish AmiaReforged.System --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.System/"
			}
		}
        stage('Deploy Classes') {
            when {
                    expression {
                        return params.DeployClasses == true && params.DeployAll == false
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.Classes --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Classes/"
            }
        }
        stage('Deploy Races') {
            when {
                    expression {
                        return params.DeployRaces == true && params.DeployAll == false
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.Races --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.Races/"
            }
        }
        stage('Deploy DMS') {
            when {
                    expression {
                        return params.DeployDms == true && params.DeployAll == false
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.DMS --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.DMS/"
            }
        }
        stage('Deploy PwEngine') {
            when {
                    expression {
                        return params.DeployPwEngine == true && params.DeployAll == false
                    }
            }
            steps {
                echo 'Deploying....'

                sh "dotnet publish AmiaReforged.PwEngine --output ${params.DEV_SERVER_BASE}/anvil/Plugins/AmiaReforged.PwEngine/"
            }
        }
    }
    post {
        always {
            discordSend description: "Builder for plugin AmiaReforged ${params.SERVER_LABEL} finished.", footer: "Build results for AmiaReforged (DEV)", link: env.BUILD_URL, result: currentBuild.currentResult, title: JOB_NAME, webhookURL: params.webhookURL
            sh "chown -R jenkins.jenkins ${WORKSPACE}"
            sh "chmod +x ${params.START_SCRIPT}"
            sh "bash ${params.START_SCRIPT}"
        }
        success {
            echo 'Build success'
        }
    }
}
